name: Build

on: [push, pull_request]

jobs:
  build:
    outputs:
      hashes: ${{ steps.hash.outputs.hashes }}

    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build Dockerfile
        shell: bash
        run: docker build -t rr-android .android

      - name: Create dist dir
        shell: bash
        run: mkdir -p obj/dist

      - name: Build RR
        shell: bash
        run: |
          docker run --rm \
            -v $(pwd):/src/rr \
            -v $(pwd)/obj/dist:/dist \
            rr-android

      - name: Generate subject
        shell: bash
        id: hash
        run: |
          # cd is needed to workaround
          # https://github.com/slsa-framework/slsa-github-generator/issues/1225
          # Fix is merged but hasn't shipped yet.
          cd obj/dist
          echo "hashes=$(sha256sum * | base64 -w0)" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v3
        with:
          name: rr
          path: obj/dist/rr-*-Android-x86_64.tar.gz

  provenance:
    needs: [build]
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v1.2.2
    with:
      base64-subjects: "${{ needs.build.outputs.hashes }}"
      upload-assets: true